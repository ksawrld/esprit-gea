<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taxi'GEA • Passage</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root {
      --bg: #0b1437;
      --panel: #111d49;
      --accent-2: #3b82f6;
      --text: #ffffff;
      --muted: #d0dcff;
      --border: #233062;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background:var(--bg)}
    header{padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);background:#0f1736}
    header img{height:48px;width:48px;border-radius:8px;object-fit:cover}
    header h1{font-size:18px;margin:0}
    .layout{display:grid;grid-template-columns:380px 1fr;height:calc(100vh - 70px)}
    @media(max-width:980px){.layout{grid-template-columns:1fr;grid-auto-rows:auto 1fr;height:auto}#map{height:70vh}}
    aside{padding:16px;background:#0f1a4a;border-right:1px solid var(--border);overflow:auto}
    #map{width:100%;height:calc(100vh - 70px);background:#07102a}
    input,select,textarea,button{font-size:14px;border:none;outline:none}
    input,select,textarea{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;background:#12204f;color:#fff}
    textarea{min-height:80px;resize:vertical}
    .btn{padding:10px 12px;border-radius:10px;background:#24388d;color:#fff;cursor:pointer;border:1px solid #3148a6}
    .btn.primary{background:var(--accent-2);border-color:#2563eb}
    .card{background:#0c183e;border:1px solid var(--border);padding:14px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .stack{display:flex;flex-direction:column;gap:12px}
    .muted{color:var(--muted);font-size:13px}
    label.muted{display:block;margin-top:8px;color:var(--muted);font-size:13px}
    .hidden{display:none}
    .small{font-size:13px;color:var(--muted)}
    #confirmBanner{position:fixed;right:18px;bottom:18px;background:#0b7a3a;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.3);display:none}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="logo" onerror="this.style.display='none'">
    <h1>ESPRIT GEA • Taxi'GEA</h1>
  </header>

  <div class="layout">
    <aside>
      <div class="stack">

        <div class="card">
          <h2>Soumettre pour passage</h2>

          <label class="muted">Nom</label>
          <input id="inputLastName" placeholder="Ex: Dupont">

          <label class="muted">Prénom</label>
          <input id="inputFirstName" placeholder="Ex: Lucas">

          <label class="muted">Téléphone</label>
          <input id="inputPhone" placeholder="+33 6 12 34 56 78">

          <label class="muted">Adresse (ou place un point)</label>
          <input id="inputLocation" placeholder="Ex: 10 rue Exemple, Meaux">

          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="geocodeBtn">Géocoder</button>
            <button class="btn" id="placeOnMapBtn">Placer un point</button>
          </div>

          <label class="muted">Point de ramassage</label>
          <select id="dropPoint">
            <option value="">Choisir un point</option>
            <option value="Gare de Meaux">Gare de Meaux</option>
            <option value="Campus IUT Meaux">Campus IUT Meaux</option>
            <option value="Centre de Mareuil">Centre de Mareuil</option>
            <option value="Autre">Autre (remarque)</option>
          </select>

          <label class="muted">Remarque</label>
          <textarea id="inputNote" placeholder="Ex: côté parking"></textarea>

          <label style="margin-top:8px"><input type="checkbox" id="consentChk"> <span class="small">J'accepte d'être contacté.</span></label>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn primary" id="submitAnon">Soumettre</button>
            <button class="btn" id="clearForm">Effacer</button>
          </div>
        </div>

        <div class="card">
          <h2>Accès admin</h2>
          <div id="authBlock">
            <label class="muted">Email admin</label>
            <input id="adminEmail" placeholder="admin@exemple.com">
            <label class="muted">Mot de passe</label>
            <input id="adminPass" type="password" placeholder="••••••••">
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn primary" id="adminSignIn">Se connecter</button>
              <button class="btn" id="adminSignOut">Se déconnecter</button>
            </div>
          </div>
        </div>

        <div class="card hidden" id="adminPanelShort">
          <h2>Panneau Admin</h2>
          <div class="muted">Tu es connecté</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="openAdminFull">Ouvrir le tableau</button>
            <button class="btn" id="exportCsvAdmin">Exporter CSV</button>
          </div>
        </div>

      </div>
    </aside>

    <main>
      <div id="map"></div>
    </main>
  </div>

  <div id="confirmBanner">✔️ Demande envoyée</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBRlEU_av-QMbB6GBCOJXSZqEps0MxOWeQ",
      authDomain: "soireeespritgea.firebaseapp.com",
      projectId: "soireeespritgea",
      storageBucket: "soireeespritgea.firebasestorage.app",
      messagingSenderId: "155827688313",
      appId: "1:155827688313:web:132270277d7b12128895a8",
      measurementId: "G-7SZK8KMG3Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // helpers to grab elements
    const $ = id => document.getElementById(id);
    const showConfirm = (txt="✔️ Demande envoyée")=>{
      const b = $("confirmBanner");
      b.textContent = txt;
      b.style.display = "block";
      setTimeout(()=> b.style.display = "none", 4000);
    };

    // map init
    const map = L.map("map").setView([48.956, 2.888], 11);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "" }).addTo(map);
    window.addEventListener("load", ()=> setTimeout(()=> map.invalidateSize(), 200));
    setTimeout(()=> map.invalidateSize(), 400);

    const mareuil = { lat:48.956, lng:2.888 };
    const markersLayer = L.layerGroup().addTo(map);
    let tempPoint = null;

    const haversine = (a,b)=>{
      const R=6371;
      const dLat=(b.lat-a.lat)*Math.PI/180;
      const dLng=(b.lng-a.lng)*Math.PI/180;
      const sa=Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(sa));
    };

    // place
    $("placeOnMapBtn").addEventListener("click", ()=>{
      alert("Clique sur la carte pour placer ton point.");
      map.once("click", e=>{
        tempPoint = e.latlng;
        L.marker(tempPoint).addTo(map).bindPopup("Point choisi").openPopup();
      });
    });

    // geocode
    async function geocode(q){
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("q", q);
      url.searchParams.set("format", "jsonv2");
      url.searchParams.set("limit", "1");
      url.searchParams.set("countrycodes","fr");
      const r = await fetch(url);
      if(!r.ok) throw new Error("Erreur géocodage: "+r.status);
      const j = await r.json();
      if(!j.length) throw new Error("Adresse introuvable");
      return { lat:+j[0].lat, lng:+j[0].lon, display:j[0].display_name };
    }

    $("geocodeBtn").addEventListener("click", async ()=>{
      const q = $("inputLocation").value.trim();
      if(!q) return alert("Tape une adresse.");
      try{
        const r = await geocode(q);
        tempPoint = { lat:r.lat, lng:r.lng, display:r.display };
        L.marker([r.lat,r.lng]).addTo(map).bindPopup("Point choisi").openPopup();
        map.panTo([r.lat,r.lng]);
      }catch(e){ console.error(e); alert(e.message); }
    });

    // clear
    $("clearForm").addEventListener("click", ()=>{
      $("inputLastName").value = "";
      $("inputFirstName").value = "";
      $("inputPhone").value = "";
      $("inputLocation").value = "";
      $("inputNote").value = "";
      $("dropPoint").value = "";
      $("consentChk").checked = false;
      tempPoint = null;
      alert("Formulaire effacé");
    });

    // submit
    $("submitAnon").addEventListener("click", async ()=>{
      const last = $("inputLastName").value.trim();
      const first = $("inputFirstName").value.trim();
      const phone = $("inputPhone").value.trim();
      const addr = $("inputLocation").value.trim();
      const note = $("inputNote").value.trim();
      const drop = $("dropPoint").value;
      const consent = $("consentChk").checked;

      if(!last || !first) return alert("Nom et prénom obligatoires.");
      if(!phone) return alert("Téléphone obligatoire.");
      if(!consent) return alert("Consentement requis.");
      if(!addr && !tempPoint && !drop) return alert("Adresse, point ou lieu obligatoire.");

      if(addr && !tempPoint){
        try{
          const r = await geocode(addr);
          tempPoint = { lat:r.lat, lng:r.lng, display:r.display };
        }catch(e){ console.error(e); return alert("Impossible de géocoder l'adresse."); }
      }

      try{
        await addDoc(collection(db,"ramassage"), {
          createdAt: new Date().toISOString(),
          lastName: last,
          firstName: first,
          phone: phone,
          note: note || null,
          lat: tempPoint ? tempPoint.lat : null,
          lng: tempPoint ? tempPoint.lng : null,
          display: tempPoint ? tempPoint.display : (addr || null),
          dropPoint: drop || null,
          venue: "Mareuil-lès-Meaux",
          consent: true
        });
        showConfirm("✔️ Demande envoyée — on te contactera si besoin");
        // small reset
        $("inputLocation").value = "";
        $("inputNote").value = "";
        $("consentChk").checked = false;
        $("dropPoint").value = "";
        tempPoint = null;
      }catch(e){ console.error(e); alert("Erreur enregistrement: "+e.message); }
    });

    // AUTH
    $("adminSignIn").addEventListener("click", ()=>{
      const email = $("adminEmail").value.trim();
      const pass = $("adminPass").value.trim();
      if(!email || !pass) return alert("Email + mot de passe requis");
      signInWithEmailAndPassword(auth, email, pass)
        .then(cred => {
          console.log("admin connected", cred.user.uid);
          alert("Connexion OK");
        })
        .catch(e => {
          console.error("auth error", e);
          alert("Erreur login: "+e.message);
        });
    });
    $("adminSignOut").addEventListener("click", ()=> {
      signOut(auth).then(()=>{ alert("Déconnecté") }).catch(e=>console.warn(e));
    });

    onAuthStateChanged(auth, user=>{
      if(user){
        $("adminPanelShort").classList.remove("hidden");
        $("authBlock").classList.add("hidden");
        setTimeout(()=>map.invalidateSize(),150);
      } else {
        $("adminPanelShort").classList.add("hidden");
        $("authBlock").classList.remove("hidden");
      }
    });

    // open admin table
    $("openAdminFull").addEventListener("click", ()=>{
      const q = query(collection(db,"ramassage"), orderBy("createdAt","asc"));
      getDocs(q).then(snap=>{
        const rows = [];
        markersLayer.clearLayers();
        let total = 0, n = 0;
        snap.forEach(doc=>{
          const d = doc.data(); rows.push(d);
          if(d.lat && d.lng){
            const dist = haversine({lat:d.lat,lng:d.lng}, mareuil);
            total += dist; n++;
            L.marker([d.lat,d.lng]).addTo(markersLayer).bindPopup(`${d.firstName} ${d.lastName}<br>${d.display||''}<br>${dist.toFixed(1)} km`);
          }
        });
        const avg = n ? (total/n).toFixed(1) : "0";
        const win = window.open("","_blank");
        if(!win){ alert("Popup bloquée — autorise les popups pour ce site"); return; }
        win.document.write(`<h2>Tableau Ramassage</h2><p>Total: ${rows.length} — Moyenne: ${avg} km</p>`);
        win.document.write('<table border=1 cellpadding=6><tr><th>#</th><th>Date</th><th>Nom</th><th>Prénom</th><th>Tél</th><th>Adresse</th><th>Dépose</th><th>Note</th></tr>');
        rows.forEach((r,i)=>{
          win.document.write(`<tr><td>${i+1}</td><td>${r.createdAt||''}</td><td>${r.lastName||''}</td><td>${r.firstName||''}</td><td>${r.phone||''}</td><td>${r.display||''}</td><td>${r.dropPoint||''}</td><td>${r.note||''}</td></tr>`);
        });
        win.document.write('</table>');
      }).catch(e=>{ console.error(e); alert("Erreur lecture: "+e.message) });
    });

    // export CSV
    $("exportCsvAdmin").addEventListener("click", ()=>{
      const q = query(collection(db,"ramassage"), orderBy("createdAt","asc"));
      getDocs(q).then(snap=>{
        const rows=[["createdAt","lastName","firstName","phone","display","dropPoint","note","lat","lng"]];
        snap.forEach(doc=>{
          const d = doc.data();
          rows.push([d.createdAt||'', d.lastName||'', d.firstName||'', d.phone||'', d.display||'', d.dropPoint||'', d.note||'', d.lat||'', d.lng||'']);
        });
        const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ramassage_export.csv';
        a.click();
      }).catch(e=>{ console.error(e); alert("Erreur export: "+e.message) });
    });

    // safety: log uncaught
    window.addEventListener('error', e=> console.error('Unhandled error', e.error || e.message));
  </script>
</body>
</html>
